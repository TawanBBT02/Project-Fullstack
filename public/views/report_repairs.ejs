<%- include('partials/header') %>
<%- include('partials/sidebar') %>

<div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-4">
    <h2 class="h4 fw-bold text-dark"><i class="bi bi-bar-chart-fill text-primary me-2"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h2>
</div>

<div class="card p-4 mb-4 shadow-sm border-0">
    <form action="/report_repairs" method="GET">
        <div class="row align-items-end">
            
            <div class="col-md-5 mb-3">
                <label class="form-label text-muted small fw-bold">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
                <select class="form-select shadow-none" name="tech_id">
                    <option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏£‡πâ‡∏≤‡∏ô) --</option>
                    <% if (typeof technicians !== 'undefined') { %>
                        <% technicians.forEach(function(t) { %>
                            <option value="<%= t.technician_id %>" <%= (typeof currentTech !== 'undefined' && currentTech == t.technician_id) ? 'selected' : '' %>>
                                <%= t.first_name %> <%= t.last_name %>
                            </option>
                        <% }); %>
                    <% } %>
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label text-muted small fw-bold">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</label>
                <select class="form-select shadow-none" name="status">
                    <option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                    <option value="Pending" <%= (typeof currentStatus !== 'undefined' && currentStatus === 'Pending') ? 'selected' : '' %>>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Pending)</option>
                    <option value="In Progress" <%= (typeof currentStatus !== 'undefined' && currentStatus === 'In Progress') ? 'selected' : '' %>>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏° (In Progress)</option>
                    <option value="Completed" <%= (typeof currentStatus !== 'undefined' && currentStatus === 'Completed') ? 'selected' : '' %>>‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (Completed)</option>
                </select>
            </div>

            <div class="col-md-3 mb-3">
                <button type="submit" class="btn btn-primary w-100 fw-bold" style="background-color: #ff6b00; border-color: #ff6b00;">
                    <i class="bi bi-funnel-fill me-1"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
            
        </div>
    </form>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h6>
            </div>
            <div class="card-body">
                <canvas id="repairChart" height="150"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h6>
            </div>
            <div class="card-body">
                <canvas id="devicePieChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm mt-2" style="border-radius: 12px;">
    <div class="card-header bg-white py-3 border-0">
        <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-list-task me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h6>
    </div>
    <div class="card-body pt-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light text-muted small">
                    <tr>
                        <th class="ps-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏á‡∏≤‡∏ô</th>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                        <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                        <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th class="text-end pe-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (repairList && repairList.length > 0) { %>
                        <% repairList.forEach(function(r) { %>
                            <tr>
                                <td class="ps-3 fw-bold text-dark">REP-<%= String(r.repair_id).padStart(3, '0') %></td>
                                <td><%= r.receive_date %></td>
                                <td><%= r.first_name %> <%= r.last_name %></td>
                                <td><small class="text-muted"><%= r.brand %> <%= r.model %></small></td>
                                <td>
                                    <% 
                                        let statusClass = 'bg-secondary';
                                        if(r.status === 'In Progress') statusClass = 'bg-warning text-dark';
                                        if(r.status === 'Completed') statusClass = 'bg-success';
                                    %>
                                    <span class="badge <%= statusClass %> rounded-pill px-3"><%= r.status %></span>
                                </td>
                                <td class="text-end pe-3">
                                    <a href="/repair-details/<%= r.repair_id %>" class="btn btn-sm btn-light border rounded-pill">
                                        <i class="bi bi-search"></i>
                                    </a>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-2 d-block mb-2"></i>
                                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (‡πÅ‡∏õ‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ EJS ‡πÄ‡∏õ‡πá‡∏ô JSON)
    const rawStatusData = <%- JSON.stringify(statusData || []) %>;
    const rawBrandData = <%- JSON.stringify(brandData || []) %>;

    // ==========================================
    // üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°)
    // ==========================================
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏Å‡∏ô X ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡πÜ
    const statusLabels = ['Pending', 'In Progress', 'Completed'];
    const statusDisplayLabels = ['‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'];
    
    const statusCounts = statusLabels.map(label => {
        const found = rawStatusData.find(item => item.status === label);
        return found ? found.count : 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0
    });

    const ctxRepair = document.getElementById('repairChart').getContext('2d');
    new Chart(ctxRepair, {
        type: 'bar', 
        data: {
            labels: statusDisplayLabels, 
            datasets: [{
                label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)',
                data: statusCounts, // <--- ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
                backgroundColor: ['#6c757d', '#ffc107', '#28a745'], 
                borderRadius: 6 
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });


    // ==========================================
    // üç© ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏ô‡∏±‡∏ó (‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)
    // ==========================================
    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô Array 
    const brandLabels = rawBrandData.map(item => item.brand || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
    const brandCounts = rawBrandData.map(item => item.count);
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠
    const pieColors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#ea4335', '#34a853'];

    const ctxDevice = document.getElementById('devicePieChart').getContext('2d');
    new Chart(ctxDevice, {
        type: 'doughnut', 
        data: {
            labels: brandLabels, // <--- ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á
            datasets: [{
                data: brandCounts, // <--- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á
                backgroundColor: pieColors, 
                borderWidth: 0
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            cutout: '70%', 
            plugins: { legend: { position: 'bottom' } } 
        }
    });
</script>
<%- include('partials/footer') %>